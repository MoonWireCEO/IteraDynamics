# ‚ö†Ô∏è DEPRECATION WARNING ‚ö†Ô∏è
# This workflow has LOOK-AHEAD BIAS (data leakage) because it:
# 1. Trains models on ALL historical data
# 2. Backfills shadow predictions on that same data (the model has "seen" it before)
# 3. Paper trades those predictions with inflated results
#
# For PROPER validation without leakage, use walkforward-cv.yml instead.
# This workflow may be useful for quick smoke tests or recent model monitoring only.

name: Paper from Shadow (‚ö†Ô∏è DEPRECATED - Has Look-Ahead Bias)

permissions:
  contents: read
  actions: read

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: "Comma-separated symbols to trade"
        required: false
        default: "SPY,QQQ"
      lookback_h:
        description: "Replay window (hours)"
        required: false
        default: "720"
      backfill_run_id:
        description: "Run ID of Backfill ML Shadow to use (blank = latest success)"
        required: false
        default: ""
      paper_ref:
        description: "Git ref (commit SHA / tag / branch) to run PAPER TRADER from"
        required: false
        default: ""   # blank = current commit

jobs:
  paper:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      MPLBACKEND: Agg
      # Paper trader knobs (unchanged)
      AE_PERF_SYMBOLS: ${{ github.event.inputs.symbols || 'SPY,QQQ' }}
      AE_PERF_LOOKBACK_H: ${{ github.event.inputs.lookback_h || '720' }}
      AE_PERF_HORIZON_MIN: "180"
      AE_PERF_SLIPPAGE_BPS: "2"
      AE_PERF_FEES_BPS: "1"
      AE_PERF_CAPITAL: "100000"
      AE_PERF_FORCE_DEMO: "false"
      AE_PERF_DEADBAND: "0.08"
      AE_PERF_MIN_FLIP_MIN: "360"
      REPLAY_CONF_MIN: "0.58"

    steps:
      # Checkout the repo AT THE REQUESTED REF for running scripts/perf/*
      - name: Checkout (paper trader ref)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.paper_ref || github.sha }}

      - name: Show paper code ref
        run: |
          echo "Paper code ref:"
          git rev-parse HEAD
          echo "Branch/Tag (if any): ${{ github.event.inputs.paper_ref || '(current SHA)' }}"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then python -m pip install -r requirements-dev.txt; fi
          python -m pip install matplotlib

      # We don‚Äôt need to (re)train here; we‚Äôre ONLY replaying the shadow backfill.
      # Still allow tiny local probe rows if you want, but they won‚Äôt affect large backfills.

      # ---------- Pull the backfilled shadow log artifact ----------
      - name: Download backfilled shadow log (latest success)
        if: ${{ github.event.inputs.backfill_run_id == '' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          repository: ${{ github.repository }}
          workflow: backfill-ml-shadow
          workflow_conclusion: success
          name: ml-shadow-backfill
          path: logs/incoming
          allow_forks: true
          if_no_artifact_found: warn

      - name: Download backfilled shadow log by run id (optional)
        if: ${{ github.event.inputs.backfill_run_id != '' }}
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.inputs.backfill_run_id }}
          repo: ${{ github.repository }}
          name: ml-shadow-backfill
          path: logs/incoming
          if_no_artifact_found: warn

      # ---------- Merge downloaded shadows into canonical log ----------
      - name: Merge downloaded shadow artifacts
        run: |
          python - <<'PY'
          import pathlib
          root = pathlib.Path("logs")
          incoming = root / "incoming"
          out = root / "signal_inference_shadow.jsonl"
          out.parent.mkdir(parents=True, exist_ok=True)
          found = list(incoming.rglob("*.jsonl")) if incoming.exists() else []
          merged = 0
          if found:
              with out.open("w", encoding="utf-8") as w:  # overwrite to ensure a clean run
                  for p in found:
                      txt = p.read_text(encoding="utf-8").strip()
                      if txt:
                          # ensure trailing newline
                          w.write(txt + ("\n" if not txt.endswith("\n") else ""))
                          merged += 1
          print(f"[merge] merged {merged} backfill shadow file(s) into {out}")
          PY

      - name: Preflight ‚Äì shadow stats
        run: |
          echo "Contents (recursive) of ./logs:"
          ls -lahR logs || true
          echo "---- tail merged canonical ----"
          tail -n 10 logs/signal_inference_shadow.jsonl || true
          echo "---- line count ----"
          wc -l logs/signal_inference_shadow.jsonl || true

      # ---------- Replay shadow ‚Üí paper trading ----------
      - name: Replay shadow ‚Üí paper trading
        run: |
          python -m scripts.perf.replay_shadow_to_paper
          echo "Trades (tail):"
          tail -n 5 logs/paper_trades.jsonl || true
          echo "Performance summary:"
          test -f models/performance_metrics.json && cat models/performance_metrics.json || echo "no performance_metrics.json"


      - name: Cross-validate model stability (k-fold)
        env:
          AE_ML_SYMBOLS: ${{ env.AE_PERF_SYMBOLS }}   # keep symbols aligned
          AE_ML_LOOKBACK_DAYS: "180"
          AE_ML_MODEL: "gb"                            # or rf/logreg/hybrid
          AE_CV_FOLDS: "5"
          AE_HORIZON_H: "1"
          CV_CONF_MIN: ${{ env.REPLAY_CONF_MIN || '0.58' }}
        run: |
          python -m scripts.ml.cv_eval
          echo "## üß™ CV Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          test -f artifacts/cv_summary.md && cat artifacts/cv_summary.md >> "$GITHUB_STEP_SUMMARY" || true


      # ---------- Summary ----------
      - name: Write summary
        run: |
          echo "### üïµÔ∏è Paper from Shadow" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Paper code ref:** \`$(git rev-parse --short HEAD)\` (input: \`${{ github.event.inputs.paper_ref || 'CURRENT' }}\`)" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "${{ github.event.inputs.backfill_run_id }}" ]; then
            echo "- **Backfill source:** run id \`${{ github.event.inputs.backfill_run_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Backfill source:** latest successful \`backfill-ml-shadow\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- **Shadow lines:** $(wc -l < logs/signal_inference_shadow.jsonl 2>/dev/null || echo 0)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Paper trades tail:**" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
          tail -n 5 logs/paper_trades.jsonl >> "$GITHUB_STEP_SUMMARY" || true
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f models/performance_metrics.json ]; then
            echo "**Performance metrics:**" >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`json" >> "$GITHUB_STEP_SUMMARY"
            cat models/performance_metrics.json >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          fi

      # ---------- Artifacts ----------
      - name: Upload paper artifacts
        uses: actions/upload-artifact@v4
        with:
          name: paper-artifacts-${{ github.event.inputs.paper_ref || 'current' }}
          if-no-files-found: warn
          path: |
            logs/signal_inference_shadow.jsonl
            logs/paper_trades.jsonl
            models/performance_metrics.json
            artifacts/perf_*.png
            artifacts/cv_summary.md
            artifacts/cv_results.json