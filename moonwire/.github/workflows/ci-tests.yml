name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    # Global env that applies to all steps unless overridden
    env:
      PYTHONPATH: ${{ github.workspace }}
      PYTHONUNBUFFERED: "1"
      MW_SOCIAL_ENABLED: "1"   # default ON; control step overrides to 0
      MW_INFERENCE_BRIDGE: 'shadow'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Run tests (+ optional tuner)
        env:
          MW_WRITE_BT_LOGS: "1"
          MW_ENV: "ci"
        run: |
          python -m pytest tests/ --maxfail=1 --disable-warnings -q
          python scripts/ml/tuner.py || true

      - name: Smoke emit one signal dual-write default
        if: success() && hashFiles('tools/emit_signal.py') != ''
        run: |
          python tools/emit_signal.py --symbol BTC --dir long --conf 0.72 --price 60000
          echo "Tail (canonical):"
          tail -n 1 logs/signal_history.jsonl || true
          echo "Tail (legacy):"
          tail -n 1 logs/signals.jsonl || true
      
      - name: Write shadow inference probe (BTC)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          from src.signal_generator import shadow_probe
          shadow_probe(["BTC"])
          print("shadow probe wrote at least one line for BTC")
          PY

      - name: Upload inference shadow log
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: inference-shadow
          path: logs/signal_inference_shadow.jsonl
          if-no-files-found: warn


      - name: Summarize inference shadow (tail)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, os, itertools
          p = "logs/signal_inference_shadow.jsonl"
          if not os.path.exists(p):
              print("no shadow log")
          else:
              tail = list(itertools.islice(open(p,"r",encoding="utf-8"), 1000000))[-5:]
              print("### Inference Shadow (last 5)")
              for ln in tail:
                  try:
                      j = json.loads(ln)
                      print(f"- {j['symbol']}  p_long={j.get('p_long'):.3f}  y_pred={j.get('y_pred')}  mode={j.get('mode')}")
                  except:
                      print("-", ln.strip()[:120])
          PY



      - name: Seed demo trades (CI only)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, time
          from pathlib import Path
          logs = Path("logs"); logs.mkdir(exist_ok=True)
          trades = logs / "trades.jsonl"
          if (not trades.exists()) or trades.stat().st_size == 0:
              now = int(time.time())
              rows = [
                  {"ts": now-3600, "symbol": "BTC", "side": "long",  "price": 60000, "qty": 0.01, "pnl": 12.0},
                  {"ts": now-2400, "symbol": "ETH", "side": "long",  "price": 3000,  "qty": 0.10, "pnl": -3.0},
                  {"ts": now-1200, "symbol": "SOL", "side": "short", "price": 156,   "qty": 1.00, "pnl": 1.5},
              ]
              with trades.open("a", encoding="utf-8") as f:
                  for r in rows:
                      f.write(json.dumps(r) + "\n")
              print("Seeded:", trades)
          else:
              print("Trades already present:", trades)
          PY

      # --- Reddit API backfill (writes logs/social_reddit.jsonl) ---
      - name: Reddit API backfill (180d)
        if: ${{ success() }}
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
          MW_REDDIT_BACKFILL_DAYS: "180"
          MW_SOCIAL_ENABLED: "1"
          MW_REDDIT_MODE: "api"
        run: |
          python -m scripts.social.backfill_reddit_api
          test -s logs/social_reddit.jsonl || (echo "No reddit data written" && exit 1)

      - name: Upload Reddit JSONL (api backfill)
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: social_reddit.jsonl
          path: logs/social_reddit.jsonl
          if-no-files-found: error

      # Fallback (RSS/demo) only if API file is missing
      - name: Social backfill (180d fallback)
        if: ${{ success() && hashFiles('logs/social_reddit.jsonl') == '' }}
        env:
          MW_OFFLINE_DEMO: "0"
          MW_SOCIAL_BACKFILL: "1"
          MW_BACKFILL_DAYS: "180"
          MW_REDDIT_MODE: "rss"
          MW_TWITTER_MODE: "demo"
        run: python -m scripts.social.backfill_social

      - name: Upload social backfill artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: social-backfill-report
          path: |
            models/social_backfill_summary.json
            artifacts/social_backfill_plots/**
          if-no-files-found: warn

      - name: Which feature_builder is used?
        run: |
          python - <<'PY'
          import importlib
          m = importlib.import_module('scripts.ml.feature_builder')
          print('USING:', m.__file__)
          PY

      # =========================
      # Set ML KNOBS once (single source of truth)
      # =========================
      - name: Set ML knobs env
        run: |
          echo "MW_ML_SYMBOLS=BTC,ETH" >> "$GITHUB_ENV"
          echo "MW_ML_LOOKBACK_DAYS=180" >> "$GITHUB_ENV"
          echo "MW_ML_MODEL=hybrid" >> "$GITHUB_ENV"              # default / fallback
          echo "MW_HORIZON_H=1" >> "$GITHUB_ENV"
          echo "MW_FEES_BPS=1" >> "$GITHUB_ENV"
          echo "MW_SLIPPAGE_BPS=2" >> "$GITHUB_ENV"
          echo "MW_CONF_GRID=0.50,0.52,0.55,0.58,0.60,0.62,0.65,0.68,0.70" >> "$GITHUB_ENV"
          echo "MW_DEBOUNCE_GRID_MIN=5,10,15,30" >> "$GITHUB_ENV"
          echo "MW_HORIZON_GRID_H=1,2,3,6" >> "$GITHUB_ENV"
          echo "TUNER_STRICT=0" >> "$GITHUB_ENV"
          echo "MW_TUNER_DEBUG=1" >> "$GITHUB_ENV"
          echo "MW_CALIBRATE_PROBS=platt" >> "$GITHUB_ENV"
          echo "MW_FIX_END_TS=2025-10-21T20:00:00Z" >> "$GITHUB_ENV"
          echo "MW_OFFLINE_DEMO=0" >> "$GITHUB_ENV"
          echo "MW_FAIL_ON_DEMO=0" >> "$GITHUB_ENV"
          echo "MW_BRANCH=${{ github.ref_name }}" >> "$GITHUB_ENV"
          echo "MW_PROTECTED_PATTERN=^main$" >> "$GITHUB_ENV"
          echo "MW_SOC_LAG_H=1" >> "$GITHUB_ENV"
          echo "MW_SOC_NORM_WIN_H=720" >> "$GITHUB_ENV"
          echo "MW_SOC_SMOOTH=0" >> "$GITHUB_ENV"
          echo "MW_SOC_SCALE=1.0" >> "$GITHUB_ENV"
          echo "MW_SOC_INTERACT=0" >> "$GITHUB_ENV"

          # === Enable per-symbol models ===
          echo "MW_PER_SYMBOL_MODELS=1" >> "$GITHUB_ENV"

          # Optional: specify different learners per coin
          #   BTC â†’ Gradient Boost, ETH â†’ Logistic Regression, SOL â†’ fallback to MW_ML_MODEL (hybrid)
          echo "MW_MODEL_MAP=BTC:rf,ETH:gb,DEFAULT:gb" >> "$GITHUB_ENV"

          # === Burst detection knobs ===
          echo "BURST_Z=2" >> "$GITHUB_ENV"
          echo "BURST_SHORT_H=6" >> "$GITHUB_ENV"
          echo "BURST_LONG_H=48" >> "$GITHUB_ENV"
          # (optional) social smoothing already in your env as MW_SOC_SMOOTH
          

      # ======================
      # A) Train: Social = ON
      # ======================
      - name: Run ML training/backtest/tuning (ON)
        env:
          MW_SOCIAL_ENABLED: "1"
          MW_SOCIAL_INCLUDE: "BTC"
        run: python -m scripts.ml.train_predict

      - name: Upload inference bundle (per-coin or flat)
        uses: actions/upload-artifact@v4
        with:
          name: inference-bundle-current
          if-no-files-found: warn
          path: |
            models/current/**/manifest.json
            models/current/**/model.joblib
            models/current/**/features.json
            models/current/index.json

      - name: Check inference bundle
        if: ${{ success() }}
        run: |
          echo "Listing models/current:"
          ls -lah models/current || echo "models/current missing"
          python - <<'PY'
          import pathlib, json
          p = pathlib.Path("models/current")
          print("exists:", p.exists())
          if p.exists():
              print("files:", [x.name for x in p.iterdir()])
              man = p/"manifest.json"
              print("has manifest?", man.exists())
              if man.exists():
                  print("manifest:", man.read_text()[:300], "...")
          PY

      - name: Sanity social ON + manifest flags
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import os, json, pathlib
          from scripts.ml.social_features import compute_social_series
          print("MW_SOCIAL_ENABLED =", os.getenv("MW_SOCIAL_ENABLED"))
          print("MW_SOCIAL_INCLUDE =", os.getenv("MW_SOCIAL_INCLUDE"))
          df = compute_social_series(pathlib.Path("."))
          print("social_enabled_runtime =", (not df.empty))
          print(df.head(3))
          man = json.load(open("models/ml_model_manifest.json"))
          print("manifest.social_enabled =", man.get("social_enabled"))
          print("manifest.social_include =", man.get("social_include"))
          print("manifest.features has social_score =", "social_score" in man.get("features", []))
          PY

      # --- Capture run config (ON)
      - name: Capture run config (ON)
        if: ${{ success() }}
        env:
          MW_SOCIAL_ENABLED: "1"
          MW_SOCIAL_INCLUDE: "BTC"
        run: |
          python - <<'PY'
          import os, json
          KEYS = [
            "MW_SOCIAL_ENABLED","MW_SOCIAL_INCLUDE","MW_ML_SYMBOLS","MW_ML_LOOKBACK_DAYS","MW_ML_MODEL",
            "MW_HORIZON_H","MW_CONF_GRID","MW_DEBOUNCE_GRID_MIN","MW_HORIZON_GRID_H",
            "MW_FEES_BPS","MW_SLIPPAGE_BPS","MW_CALIBRATE_PROBS","MW_FIX_END_TS","MW_SOC_LAG_H","MW_SOC_NORM_WIN_H","MW_SOC_SMOOTH","MW_SOC_SCALE","MW_SOC_INTERACT",
            "manifest_model_type","manifest_social_enabled","manifest_social_include","manifest_has_social_score_feature"
          ]
          env_on = {k: os.getenv(k, "") for k in KEYS}
          try:
              man = json.load(open("models/ml_model_manifest.json"))
          except Exception:
              man = {}
          env_on["manifest_model_type"] = man.get("model_type")
          env_on["manifest_social_enabled"] = man.get("social_enabled")
          env_on["manifest_social_include"] = man.get("social_include")
          env_on["manifest_has_social_score_feature"] = "social_score" in man.get("features", [])
          json.dump(env_on, open("models/run_config_on.json","w"), indent=2)
          PY


      - name: Preserve social-ON artifacts (manifest + summary)
        if: ${{ success() }}
        run: |
          test -f models/backtest_summary.json || (echo "backtest_summary.json missing" && exit 1)
          test -f models/ml_model_manifest.json || (echo "ml_model_manifest.json missing" && exit 1)
          cp models/backtest_summary.json models/backtest_summary_on.json
          cp models/ml_model_manifest.json models/ml_model_manifest_on.json

      # =======================
      # B) Train: Social = OFF
      # =======================
      - name: Run ML training/backtest/tuning (OFF / control)
        env:
          MW_SOCIAL_ENABLED: "0"
          MW_SOCIAL_INCLUDE: ""
        run: |
          python -m scripts.ml.train_predict
          mv models/backtest_summary.json models/backtest_summary_off.json
          cp models/ml_model_manifest.json models/ml_model_manifest_off.json

      - name: Sanity social OFF + manifest flags
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import os, json, pathlib
          from scripts.ml.social_features import compute_social_series
          print("MW_SOCIAL_ENABLED =", os.getenv("MW_SOCIAL_ENABLED"))
          print("MW_SOCIAL_INCLUDE =", os.getenv("MW_SOCIAL_INCLUDE"))
          df = compute_social_series(pathlib.Path("."))
          print("social_enabled_runtime =", (not df.empty))
          print(df.head(3) if not df.empty else "EMPTY")
          man = json.load(open("models/ml_model_manifest.json"))
          print("manifest.social_enabled =", man.get("social_enabled"))
          print("manifest.social_include =", man.get("social_include"))
          print("manifest.features has social_score =", "social_score" in man.get("features", []))
          PY

      # --- Capture run config (OFF)
      - name: Capture run config (OFF)
        if: ${{ success() }}
        env:
          MW_SOCIAL_ENABLED: "0"
          MW_SOCIAL_INCLUDE: ""
        run: |
          python - <<'PY'
          import os, json
          KEYS = [
            "MW_SOCIAL_ENABLED","MW_SOCIAL_INCLUDE","MW_ML_SYMBOLS","MW_ML_LOOKBACK_DAYS","MW_ML_MODEL",
            "MW_HORIZON_H","MW_CONF_GRID","MW_DEBOUNCE_GRID_MIN","MW_HORIZON_GRID_H",
            "MW_FEES_BPS","MW_SLIPPAGE_BPS","MW_CALIBRATE_PROBS","MW_FIX_END_TS","MW_SOC_LAG_H","MW_SOC_NORM_WIN_H","MW_SOC_SMOOTH","MW_SOC_SCALE","MW_SOC_INTERACT",
            "manifest_model_type","manifest_social_enabled","manifest_social_include","manifest_has_social_score_feature"
          ]
          env_off = {k: os.getenv(k, "") for k in KEYS}
          try:
              man = json.load(open("models/ml_model_manifest.json"))
          except Exception:
              man = {}
          env_off["manifest_model_type"] = man.get("model_type")
          env_off["manifest_social_enabled"] = man.get("social_enabled")
          env_off["manifest_social_include"] = man.get("social_include")
          env_off["manifest_has_social_score_feature"] = "social_score" in man.get("features", [])
          json.dump(env_off, open("models/run_config_off.json","w"), indent=2)
          PY


      - name: Render Run Configs (A/B)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, os, html

          on  = json.load(open("models/run_config_on.json"))
          off = json.load(open("models/run_config_off.json"))

          keys = [
            "MW_SOCIAL_ENABLED","MW_SOCIAL_INCLUDE","MW_ML_SYMBOLS","MW_ML_LOOKBACK_DAYS","MW_ML_MODEL",
            "MW_HORIZON_H","MW_CONF_GRID","MW_DEBOUNCE_GRID_MIN","MW_HORIZON_GRID_H",
            "MW_FEES_BPS","MW_SLIPPAGE_BPS","MW_CALIBRATE_PROBS","MW_FIX_END_TS",
            "manifest_model_type","manifest_social_enabled","manifest_social_include","manifest_has_social_score_feature"
          ]

          def g(d,k): 
              v = d.get(k, "")
              # stringify lists/tuples just in case
              if isinstance(v, (list, tuple)): v = ",".join(map(str, v))
              return "" if v is None else str(v)

          # 1) Pretty Markdown table
          md = []
          md.append("### âš™ï¸ Run Configs (A/B)")
          md.append("| Param | ON | OFF |")
          md.append("|---|---|---|")
          for k in keys:
              md.append(f"| {k} | {g(on,k)} | {g(off,k)} |")

          # 2) Copy-paste TSV block
          tsv = []
          tsv.append("Param\tON\tOFF")
          for k in keys:
              tsv.append(f"{k}\t{g(on,k)}\t{g(off,k)}")

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as out:
              out.write("\n".join(md) + "\n\n")
              out.write("<details><summary>Copy-paste (TSV)</summary>\n\n")
              out.write("```\n" + "\n".join(tsv) + "\n```\n")
              out.write("</details>\n\n")
          PY


          

      # =========================
      # C) Compare + Summarize
      # =========================
      - name: Restore social-ON artifacts (manifest + summary)
        if: ${{ success() }}
        run: |
          cp models/backtest_summary_on.json models/backtest_summary.json
          cp models/ml_model_manifest_on.json models/ml_model_manifest.json

      - name: Model & Feature Snapshot (robust)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, pathlib, os

          root = pathlib.Path(".")
          cur_manifest = root / "models/current/manifest.json"
          cur_model    = root / "models/current/model.joblib"
          cur_feats    = root / "models/current/features.json"
          legacy_manifest = root / "models/ml_model_manifest.json"

          model_path = None
          features = None
          model_type = None
          symbol = (os.getenv("MW_ML_SYMBOLS") or "BTC").split(",")[0].strip()

          # 1) Prefer bundle in models/current/
          if cur_manifest.exists():
              try:
                  m = json.loads(cur_manifest.read_text(encoding="utf-8"))
                  model_type = m.get("model_type") or m.get("type")
                  fo = m.get("feature_order") or m.get("features")
                  if isinstance(fo, list) and fo:
                      features = fo
                  if cur_model.exists():
                      model_path = str(cur_model)
              except Exception:
                  pass

          if features is None and cur_feats.exists():
              try:
                  fj = json.loads(cur_feats.read_text(encoding="utf-8"))
                  if isinstance(fj, list) and fj:
                      features = fj
                  elif isinstance(fj, dict) and "feature_order" in fj:
                      features = fj["feature_order"]
              except Exception:
                  pass

          # 2) Fallback to legacy manifest
          if (model_path is None or features is None) and legacy_manifest.exists():
              try:
                  m = json.loads(legacy_manifest.read_text(encoding="utf-8"))
                  if model_type is None:
                      model_type = m.get("model_type")
                  fo = m.get("feature_list") or m.get("features")
                  if features is None and isinstance(fo, list) and fo:
                      features = fo
              except Exception:
                  pass

          head = (features or [])[:8]
          print("### ðŸ§ª Model & Feature Snapshot")
          print(f"model_type: {model_type or 'unknown'}")
          print(f"feature_count: {len(features or [])}")
          print(f"features_head: {', '.join(head) if head else '(none)'}")
          print(f"model_path: {model_path or 'NOT FOUND'}")
          print(f"symbol: {symbol}")

          # Optional: preview last-row features if your earlier step saved it
          try:
              feats_path = root / f"artifacts/features_preview_{symbol}.json"
              if feats_path.exists():
                  row = json.loads(feats_path.read_text(encoding="utf-8"))
                  print("\nTop 12 feature values (last row):")
                  for k, v in list(row.items())[:12]:
                      print(f"- {k}: {v}")
          except Exception:
              pass
          PY


      - name: Compare social ON vs OFF (aggregate)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, os
          on  = json.load(open("models/backtest_summary_on.json"))
          off = json.load(open("models/backtest_summary_off.json"))
          A, B = on["aggregate"], off["aggregate"]
          def line(k, fmt=".4f"):
              ao, bo = A[k], B[k]
              d = ao - bo
              return f"{k}: ON={ao:{fmt}}  OFF={bo:{fmt}}  Î”={d:+{fmt}}"
          lines = [
              "### A/B: Social ON vs OFF",
              line("win_rate"), line("profit_factor"), line("signals_per_day"), line("max_drawdown"),
              f"trades: ON={A.get('n_trades','?')}  OFF={B.get('n_trades','?')}",
          ]
          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as out:
              out.write("\n".join(lines) + "\n\n")
          PY

      - name: Compare per-symbol (ON vs OFF)
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import json, os
          on  = json.load(open("models/backtest_summary_on.json"))
          off = json.load(open("models/backtest_summary_off.json"))
          lines = ["### A/B per-symbol (Social ON â€“ OFF)"]
          for sym in sorted(set(on["per_symbol"]) | set(off["per_symbol"])):
              Ao, Bo = on["per_symbol"].get(sym, {}), off["per_symbol"].get(sym, {})
              def g(d,k,default=float('nan')): return d.get(k, default)
              metrics = ["win_rate","profit_factor","signals_per_day","max_drawdown","n_trades"]
              parts = []
              for m in metrics:
                  a, b = g(Ao,m), g(Bo,m)
                  if isinstance(a,(int,float)) and isinstance(b,(int,float)):
                      parts.append(f"{m} Î”={a-b:+.4f}")
              lines.append(f"- {sym}: " + ", ".join(parts))
          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as out:
              out.write("\n".join(lines) + "\n\n")
          PY

      # (Optional) provenance + feature verification
      - name: Show data provenance (debug)
        if: ${{ success() }}
        run: |
          echo "data_provenance.json:"
          test -f artifacts/data_provenance.json && cat artifacts/data_provenance.json || echo "not found"

      - name: Verify social features are in use
        if: ${{ success() }}
        run: python -m scripts.ci.verify_social_features

      # =========================
      # Uploads & extras
      # =========================
      - name: Upload ML artifacts (JSON/PNGs/Logs)
        uses: actions/upload-artifact@v4
        with:
          name: ml-core
          if-no-files-found: warn
          path: |
            models/ml_model_manifest.json
            models/backtest_summary.json
            models/signal_thresholds.json
            logs/trades.jsonl
            logs/equity_curve.jsonl
            artifacts/ml_roc_pr_curve.png
            artifacts/ml_feature_importance.png
            artifacts/bt_equity_curve.png
            artifacts/bt_drawdown.png
            artifacts/bt_returns_hist.png
            artifacts/bt_signals_per_day.png

      - name: Train trigger likelihood models (logistic)
        if: ${{ success() }}
        env:
          DEMO_MODE: "true"
        run: |
          python -m src.ml.train_trigger_model --days 14 --interval hour
          echo "Models in ./models:"
          ls -lah models || true

      - name: Assert logistic artifacts exist
        if: ${{ success() }}
        run: |
          test -f models/trigger_likelihood_v0.joblib    || (echo "missing logistic model" && exit 1)
          test -f models/trigger_likelihood_v0.meta.json || (echo "missing logistic meta"  && exit 1)

      - name: Upload logistic model artifacts
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: trigger-likelihood-v0
          path: |
            models/trigger_likelihood_v0.joblib
            models/trigger_likelihood_v0.meta.json
          if-no-files-found: error
          retention-days: 14

      - name: Build training data from logs (join)
        if: ${{ success() }}
        env:
          DEMO_MODE: "true"
          TRAINING_JOIN_WINDOW_MIN: "5"
        run: |
          python -m src.ml.training_data
          echo "Training data status:"
          wc -l models/training_data.jsonl || true
          tail -n 3 models/training_data.jsonl || true

      - name: Retrain from training data (v0.5.1)
        if: ${{ success() }}
        env:
          MODEL_VERSION: "v0.5.1"
          TRAIN_LOG_PATH: "models/training_data.jsonl"
          SAVE_MODEL_DIR: "models"
        run: |
          python -m src.ml.retrain_from_log --train-log "$TRAIN_LOG_PATH" --save-dir "$SAVE_MODEL_DIR" --version "$MODEL_VERSION" || true
          echo "Retrained artifacts (if any):"
          ls -lah models || true
          ls -lah "models/$MODEL_VERSION" || true

      - name: Upload retrained model artifacts (v0.5.1)
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: trigger-likelihood-v051
          path: |
            models/v0.5.1/**
          if-no-files-found: warn
          retention-days: 14

      - name: Prep artifacts dir
        if: ${{ success() }}
        run: mkdir -p artifacts

      - name: Debug market env
        if: ${{ success() }}
        run: |
          python - <<'PY'
          import os
          print("MW_DEMO =", os.getenv("MW_DEMO"))
          print("DEMO_MODE =", os.getenv("DEMO_MODE"))
          print("Has API key? ->", bool(os.getenv("MW_CG_API_KEY")))
          print("MW_CG_BASE_URL =", os.getenv("MW_CG_BASE_URL"))
          PY

      - name: "Smoke: emit one signal (dual-write default)"
        if: ${{ success() }}
        run: |
          python tools/emit_signal.py --symbol BTC --dir long --conf 0.72 --price 60000
          echo "Tail (canonical):"
          tail -n 1 logs/signal_history.jsonl || true
          echo "Tail (legacy):"
          tail -n 1 logs/signals.jsonl || true

      - name: Upload data provenance
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: data-provenance
          path: artifacts/data_provenance.json
          if-no-files-found: warn
          retention-days: 14

      - name: Build demo summary (read-only)
        if: ${{ success() }}
        env:
          DEMO_MODE: "true"
          MW_DEMO: "false"
          MW_CG_API_KEY: ${{ secrets.MW_CG_API_KEY }}
          MW_CG_BASE_URL: "https://api.coingecko.com/api/v3"
          MPLBACKEND: "Agg"
          DEMO_RICH_SCORES: "true"
          TL_DRIFT_Z_THRESHOLD: "0.5"
          TL_DRIFT_PER_FEATURE_PENALTY: "0.1"
          METRICS_MIN_LABELS: "5"
          METRICS_LOOKBACK_HOURS: "72"
          METRICS_MIN_LABELS_ORIGIN: "3"
          TL_LOG_FALLBACK_ORIGIN: "rss_news"
          MW_ACCURACY_WINDOW_H: "72"
          MW_CAL_WINDOW_H: "72"
          MW_CAL_BINS: "10"
          MW_CAL_MIN_LABELS: "50"
          MW_CAL_MAX_ECE: "0.06"
          MW_CAL_PER_ORIGIN: "true"
          ARTIFACTS_DIR: ${{ github.workspace }}/artifacts
          MW_CG_COINS: "bitcoin,ethereum,solana"
          MW_CG_VS_CURRENCY: "usd"
          MW_CG_LOOKBACK_H: "72"
          MW_CG_RATE_LIMIT_PER_MIN: "25"
          MW_REDDIT_MODE: "rss"
          MW_REDDIT_SUBS: "CryptoCurrency,Bitcoin,ethtrader,Solana"
          MW_REDDIT_SORT: "new"
          MW_REDDIT_LOOKBACK_H: "72"
          MW_TWITTER_MODE: "demo"
          MW_TWITTER_KEYWORDS: "bitcoin,ethereum,solana,crypto"
          MW_TWITTER_LOOKBACK_H: "72"
          MW_DRIFT_ECE_THRESH: "0.06"
          MW_DRIFT_MIN_BUCKETS: "3"
          MW_DRIFT_GRACE_H: "6"
          MW_DRIFT_REQUIRE_OVERLAP: "false"
          MW_DRIFT_ACTION: "dryrun"
          MW_DRIFT_COOLDOWN_H: "12"
          MW_THRESHOLD_MAX_SHIFT: "0.10"
          MW_THRESHOLD_MIN_PRECISION: "0.75"
          MW_THRESHOLD_MIN_LABELS: "10"
          MW_RETRAIN_ACTION: "dryrun"
          MW_RETRAIN_MIN_LABELS: "300"
          MW_RETRAIN_LOOKBACK_DAYS: "30"
          MW_RETRAIN_COOLDOWN_H: "24"
          MW_RETRAIN_EVAL_HOLDOUT_DAYS: "7"
          MW_RETRAIN_PROMOTION_CRITERIA: "precision_delta_min=0.01,ece_delta_max=-0.01,f1_delta_min=0"
          MW_RETRAIN_MAX_CANDIDATES: "3"
          MW_CORR_LOOKBACK_H: "72"
          MW_LEADLAG_LOOKBACK_H: "72"
          MW_LEADLAG_MAX_SHIFT_H: "12"
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: python scripts/mw_demo_summary.py

      # Demo social ingest only for draft PRs
      - name: Social demo ingest (Reddit/Twitter)
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.draft == true }}
        env:
          MW_DEMO: "true"
          MW_REDDIT_MODE: "rss"
          MW_REDDIT_SUBS: "CryptoCurrency,Bitcoin,ethtrader,Solana"
          MW_REDDIT_SORT: "new"
          MW_REDDIT_LOOKBACK_H: "72"
          MW_TWITTER_MODE: "demo"
          MW_TWITTER_KEYWORDS: "bitcoin,ethereum,solana,crypto"
          MW_TWITTER_LOOKBACK_H: "72"
        run: |
          python -m scripts.social.reddit_lite_ingest
          python -m scripts.social.twitter_lite_ingest
          echo "Reddit/Twitter demo ingest complete."

      # -----------------------------
      # Artifact uploads begin here
      # -----------------------------
      - name: Upload drift response plan
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: drift-response-plan
          path: models/drift_response_plan.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload governance actions log
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: governance-actions-log
          path: logs/governance_actions.jsonl
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload drift response plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: drift-response-plots
          path: |
            artifacts/drift_response_timeline.png
            artifacts/drift_response_backtest_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload retrain plan
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: retrain-plan
          path: models/retrain_plan.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload retrain plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: retrain-plots
          path: |
            artifacts/retrain_eval_*.png
            artifacts/retrain_reliability_*.png
            artifacts/retrain_confusion_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload model registry
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: model-registry
          path: models/model_registry.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload calibration reliability JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: calibration-reliability
          path: models/calibration_reliability.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload calibration reliability plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: calibration-reliability-plots
          path: artifacts/cal_reliability_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload calibration per-origin JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: calibration-per-origin
          path: models/calibration_per_origin.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload market context JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: market-context
          path: models/market_context.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload market trend charts
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: market-trends
          path: |
            artifacts/market_trend_price_*.png
            artifacts/market_trend_returns_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload social reddit context
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: social-reddit-context
          path: models/social_reddit_context.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload reddit plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: reddit-plots
          path: |
            artifacts/reddit_activity_*.png
            artifacts/reddit_bursts_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload cross-origin correlation JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: cross-origin-correlation
          path: models/cross_origin_correlation.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload cross-origin correlation plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: cross-origin-correlation-plots
          path: |
            artifacts/corr_heatmap.png
            artifacts/corr_leadlag.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload leadâ€“lag analysis JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: leadlag-analysis
          path: models/leadlag_analysis.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload leadâ€“lag plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: leadlag-plots
          path: |
            artifacts/leadlag_heatmap.png
            artifacts/leadlag_ccf_*.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload model lineage JSON
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: model-lineage
          path: models/model_lineage.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload model lineage plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: model-lineage-plots
          path: artifacts/model_lineage_graph.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload model performance trend
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: model-performance-trend
          path: models/model_performance_trend.json
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload model performance trend plots
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: model-performance-trend-plots
          path: |
            artifacts/model_performance_trend_metrics.png
            artifacts/model_performance_trend_alerts.png
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload governance dashboard
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: governance-dashboard
          path: |
            artifacts/governance_dashboard.html
            artifacts/governance_dashboard.png
            models/governance_dashboard_manifest.json
          if-no-files-found: warn
          retention-days: 14

      - name: Show artifacts (debug)
        if: ${{ success() }}
        run: |
          echo "Artifacts in repo root:"
          ls -lah
          echo "Artifacts in ./artifacts:"
          ls -lah artifacts || true
          echo "Models in ./models:"
          ls -lah models || true
          test -f artifacts/demo_summary.md || (echo "demo_summary.md not found" && exit 1)

      - name: Publish CI summary
        if: ${{ success() }}
        run: |
          echo "## MoonWire CI Demo Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          cat artifacts/demo_summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload demo-summary artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: moonwire-demo
          path: artifacts/*
          if-no-files-found: error
          retention-days: 14
